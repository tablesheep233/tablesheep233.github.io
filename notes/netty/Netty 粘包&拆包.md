---
layout:     note
title:      "netty learn"
subtitle:   " \"netty learn\""
author:     "tablesheep"
catalog: true
hide-in-nav: true
header-style: text
tags:
- note
- netty
---



## TCPç²˜åŒ…åŽŸå› 

> tcp socketè¿žæŽ¥åœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ªå‘é€(send)ç¼“å†²åŒºå’ŒæŽ¥æ”¶(recv)ç¼“å†²åŒºã€‚å‘é€æ—¶æ•°æ®åŒ…å…ˆå‘é€åˆ°å‘é€ç¼“å†²åŒºä¸­ï¼Œç”±Nagleç®—æ³•å†³å®šæ˜¯ä¸æ˜¯ç«‹å³å‘é€ã€‚æŽ¥æ”¶æ—¶ï¼Œå…ˆåˆ°æŽ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œå†ä»Žå†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚

- å‘é€ç«¯ï¼šç”±äºŽNagleç®—æ³•å¯èƒ½å¯¼è‡´å¤šä¸ªåŒ…ç§¯ç´¯åœ¨å‘é€ç¼“å†²åŒºåˆ°ä¸€å®šé‡æˆ–è¶…æ—¶æ‰ä¸€èµ·å‘ç”Ÿ

- æŽ¥æ”¶ç«¯ï¼šåº”ç”¨ç¨‹åºæœªèƒ½åŠæ—¶å¤„ç†å¯¼è‡´åŒ…å †ç§¯åœ¨æŽ¥æ”¶ç¼“å†²åŒºå¯¼è‡´

  

  æ ¹æœ¬åŽŸå› ï¼Œæ•°æ®åŒ…ä¹‹é—´æ²¡æœ‰åŠžæ³•åŒºåˆ†ç•Œé™ï¼Œå¯¼è‡´åº”ç”¨å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯ã€‚



## Nettyç²˜åŒ…è§£å†³æ–¹æ¡ˆ

### FixedLengthFrameDecoder

æŒ‡å®šæ¶ˆæ¯çš„é•¿åº¦ï¼Œä¸è¶³çš„éœ€è¦å¡«å……ï¼Œæ¯”è¾ƒä¸çµæ´»ã€‚



### LineBasedFrameDecoder

ä½¿ç”¨ "\n" æˆ–è€… "\r\n" åˆ’åˆ†ä¸€æ¡æ¶ˆæ¯ï¼Œæž„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šæ¶ˆæ¯æœ€å¤§é•¿åº¦ï¼Œå½“è¾¾åˆ°æœ€å¤§é•¿åº¦è¿˜æ²¡è§£æžå‡ºæ¶ˆæ¯åˆ™ä¼šæŠ¥é”™ã€‚



### DelimiterBasedFrameDecoder

æŒ‡å®šåˆ†éš”ç¬¦ä½œä¸ºæ¶ˆæ¯åˆ†éš”ç¬¦



### LengthFieldPrepender

é•¿åº¦ç¼–ç å™¨

```java
public LengthFieldPrepender(
        ByteOrder byteOrder,  //æŒ‡å®šæ¶ˆæ¯é•¿åº¦æŒ‰å¤§ç«¯æ¨¡å¼è¿˜æ˜¯å°ç«¯æ¨¡å¼
        int lengthFieldLength, //é•¿åº¦ä¿¡æ¯å­—æ®µé•¿åº¦
        int lengthAdjustment, //é•¿åº¦ä¿¡æ¯è°ƒæ•´
        boolean lengthIncludesLengthFieldLength //é•¿åº¦å ç”¨çš„å­—èŠ‚æ˜¯å¦ç®—åœ¨æ¶ˆæ¯é•¿åº¦ä¸­ï¼Œtrue åˆ™é•¿åº¦ä¸º åŽŸå§‹æ¶ˆæ¯é•¿åº¦ + é•¿åº¦å ç”¨çš„å­—èŠ‚é•¿åº¦
) {
......
}
```



### LengthFieldBasedFrameDecoder

é•¿åº¦è§£ç å™¨

```java
public LengthFieldBasedFrameDecoder(
        ByteOrder byteOrder, //æŒ‡å®šæ¶ˆæ¯é•¿åº¦æŒ‰å¤§ç«¯æ¨¡å¼è¿˜æ˜¯å°ç«¯æ¨¡å¼
        int maxFrameLength,  //æœ€å¤§çš„æ¶ˆæ¯é•¿åº¦
        int lengthFieldOffset, //é•¿åº¦ä¿¡æ¯å­—æ®µå¼€å§‹çš„åç§»
        int lengthFieldLength, //é•¿åº¦ä¿¡æ¯å­—æ®µé•¿åº¦
        int lengthAdjustment, //é•¿åº¦ä¿¡æ¯å­—æ®µåŽï¼Œè°ƒæ•´å‡ ä½åŽä¸ºçœŸæ­£çš„æ¶ˆæ¯
        int initialBytesToStrip, //è§£ç åŽåŽ»é™¤å‡ ä¸ªå­—èŠ‚ï¼Œå¯ä»¥ç”¨äºŽæŠŠé•¿åº¦ä¿¡æ¯ç­‰å¤šä½™ä¿¡æ¯åŽ»é™¤
        boolean failFast //è¶…è¿‡æœ€å¤§é•¿åº¦åŽæ˜¯å¦å¿«é€Ÿå¤±è´¥
) {
......
}
```



å…³äºŽ`lengthAdjustment`ï¼Œæ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œä¸¾ä¸¤ä¸ªðŸŒ°

ðŸŒ°

- lengthFieldOffset ï¼š0 ï¼Œ é•¿åº¦åç§»é‡ä»Ž0å¼€å§‹
- lengthFieldLength ï¼š2 ï¼Œé•¿åº¦ä¿¡æ¯å 2å­—èŠ‚
- lengthAdjustment ï¼š-2ï¼Œé•¿åº¦ä¿¡æ¯è¡¥å¿è°ƒæ•´ä¸º-2
- initialBytesToStrip ï¼š 2ï¼Œè§£ç åŽ»é™¤2å­—èŠ‚

é•¿åº¦ä¿¡æ¯è®°å½•ä¸º0x000E(14)ï¼ŒçœŸå®žå†…å®¹é•¿åº¦ä¸º0x000C(12) ï¼ˆå¼•å·ä¸ç®—ï¼‰ï¼Œæ•´ä¸ªæ¶ˆæ¯é•¿åº¦ä¸º14ï¼ŒlengthAdjustment è°ƒæ•´ -2ï¼Œè§£ç åŽ»æŽ‰2é•¿åº¦çš„å­—èŠ‚ï¼Œå¯å¾—çœŸæ­£çš„å†…å®¹ã€‚

```
  +--------+----------------+      +----------------+
  + 0x000E | "HELLO, WORLD" |   -> | "HELLO, WORLD" |  
  +--------+----------------+      +----------------+   
```



ðŸŒ°ðŸŒ°

- lengthFieldOffset ï¼š0 ï¼Œ é•¿åº¦åç§»é‡ä»Ž0å¼€å§‹
- lengthFieldLength ï¼š2 ï¼Œé•¿åº¦ä¿¡æ¯å 2å­—èŠ‚
- lengthAdjustment ï¼š2ï¼Œé•¿åº¦ä¿¡æ¯è¡¥å¿è°ƒæ•´ä¸º-2
- initialBytesToStrip ï¼š 4ï¼Œè§£ç åŽ»é™¤2å­—èŠ‚

é•¿åº¦ä¿¡æ¯è®°å½•ä¸º0x000C(12)ï¼ŒçœŸå®žå†…å®¹é•¿åº¦ä¸º0x000C(12) ï¼ˆå¼•å·ä¸ç®—ï¼‰ï¼Œæ•´ä¸ªæ¶ˆæ¯é•¿åº¦ä¸º18ï¼ŒlengthAdjustment è°ƒæ•´ 2ï¼Œè§£ç åŽ»æŽ‰4é•¿åº¦çš„å­—èŠ‚ï¼Œå¯å¾—çœŸæ­£çš„å†…å®¹ã€‚

```
+--------+----------+----------------+      +----------------+
| 0x000C |  0x0000  | "HELLO, WORLD" |  ->  | "HELLO, WORLD" |
+--------+----------+----------------+      +----------------+
```

 